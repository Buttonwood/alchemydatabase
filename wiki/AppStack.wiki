= Alchemy's App Stack =

*WARNING: Alchemy's App Stack is VERY experimental*

Alchemy's App Stack refers to using Alchemy Database as a webserver-datastore stack. Turning on {{{webservermode}}} will activate HTTP serving on Alchemy's listening port. To provide a layer to protect database data from the outside world, in {{{webservermode}}} there are only 2 paths to access data:
  * whitelisted-IPs: App-servers whose IP addresses have been whitelisted in {{{redis.conf}}} can directly access Alchemy Database
  * other-IPs -> whitelisted lua functions: other IP addresses (i.e. external) can only call whitelisted lua functions (which then access the DB), ALL other calls (e.g. GET,SET,INSERT,SELECT) are prohibited.

Alchemy's App Stack supports both HTTP and redis' protocol, the latter can be accessed in Javascript via a Flash (Actionscript _TODO LINK_) object and has improved performance.

The following is a diagram of how Alchemy can be used in a Short-Stack architecture:

http://allinram.info/alsosql/AlchemyShortStack.png

Simple requests (via HTTP, Javascript, or Flash) can be processed by a whitelisted lua function in Alchemy Database.

To configure this setup, the following settings must be activated in the file *redis.conf*:
{{{
  webservermode yes
  include_lua functions.lua
  webserver_index_function index_page
  webserver_whitelist_address 192.168.1.1
  webserver_whitelist_netmask 255.255.255.0
}}}

The variable {{{webservermode}}} turns the app-stack on.

The variable {{{include_lua}}} points to a file that contains both whitelisted lua modules (start w/ "WL`_`" and are callable directly from the frontend) and normal non-whitelisted (helper) functions.

Example functions.lua
{{{
function htmlify(t)
  return '<html>' .. h .. '</html>';
end
function WL_index_page() 
  return htmlify('HI I AM THE INDEX PAGE');
end
function WL_welcome(user) 
  return htmlify'<h2>HI: ' + user + '</h2><img src ="/STATIC/logo.png"/>');
end
}}}

The variable {{{webserver_index_function}}} is the function that is called, when "GET / HTTP/1.0" is called, or it is the function that generates the index.html page (in the above whitelist.lua, {{{index_page()}}} would be called).

The HTTP call {{{GET /welcome/user333 HTTP/1.0}}} would be translated to the lua function {{{WL_welcome('user333');}}} and the HTML {{{'<html><h2>HI: user333</h2><img src ="/STATIC/logo.png"/></html>}}} would be returned as a HTTP 200.

The function {{{htmlify()}}} is a helper function and *NOT* callable from the frontend. The HTTP call {{{GET /htmlify/HIYA HTTP/1.0}}} would be translated to {{{WL_htmlify('HIYA');}}} and would result in a 404 as the function is not defined.

The variables {{{webserver_whitelist_address}}} and {{{webserver_whitelist_netmask}}} define the range of ip-addresses that will be allowed DIRECT access to Alchemy's Database (i.e. the whitelisted ips). These whitelisted ips are for App-Servers.

Together whitelisted lua functions (start w/ "WL`_`") and whitelisted IPs, provide a very crude security framework.

A blog explaining the why, when, and how of the App-Stack can be found [http://jaksprats.wordpress.com/2011/07/13/the-App -stack/ here]

The Actionscript and Jsquery libraries can be found here: _TODO: LINK_

=== STATIC FILES ==
A backdoor for static files has been built in. Any key starting w/ "STATIC/" can be served directly from Alchemy.

So the HTTP request "GET /STATIC/a.gif HTTP/1.0\r\n\r\n" is allowed from the outside world and maps to the Alchemy command "GET STATIC/a.gif"

=== HTTP Interface ===
HTTP Request Headers are made available in Lua via the associative array {{{HTTP_HEADER[]}}}. If you want the value of the HTTP Request Header 'Host', it is accessible in Lua as {{{HTTP_HEADER['Host']}}}

HTTP Request Cookies are made available in Lua via the associative array {{{COOKIE[]}}}. If you want the value of the HTTP Request Cookie 'mycookie', it is accessible in Lua as {{{COOKIE['mycookie']}}}

Setting HTTP Response Headers can be done in Lua via the Lua function {{{SetHttpResponseHeader}}}. Setting the HTTP Response Header 'Expires', would be done by calling {{{SetHttpResponseHeader('Expires', 'Wed, 09 Jun 2021 10:18:14 GMT');}}}. Setting the HTTP Response Cookie 'mycookie' can be done in Lua by calling {{{SetHttpResponseHeader('Set-Cookie', 'mycookie=value_for_mycookie; Expires=Wed, 09 Jun 2021 10:18:14 GMT; path=/;');}}}

HTTP Redirects can be called from Lua via the function {{{SetHttpRedirect(redirect_url);}}}. To redirect to the page 'index', call: {{{SetHttpRedirect('/index_page'); return;}}} and return immediately w/ no return value.

=== DEMO ===
A port of the demo app [http://retwis.antirez.com/ retwis] (written in php) to Alchemy's App Stack Lua can be found [https://github.com/JakSprats/Alchemy-Database/blob/master/redis_unstable/src/docroot/retwis_whitelist.lua here]